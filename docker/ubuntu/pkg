FROM docker.codingcafe.org/xkszltl/roaster/ubuntu:stage-font

ARG LABEL_BUILD_ID=Undefined
LABEL BUILD_ID=$LABEL_BUILD_ID

COPY [".", "/etc/roaster/scripts"]

RUN sudo apt-get update -y \
    && sudo apt-get upgrade -y \
    && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
        asciidoc \
        autoconf{,-archive} automake autopoint \
        axel \
        bash-completion \
        bc \
        binutils \
        bison \
        bsdmainutils \
        bzip2 pbzip2 \
        ccache \
        cmake{,-curses-gui} \
        cpio \
        cuda lib{cudnn7,nccl,nvinfer}-dev \
        curl \
        default-jdk ant maven \
        docker-ce \
        flex \
        g++{,-{4,5,6,7,8}} \
        gdb \
        gettext \
        gfortran{,-{5,6,7,8}} \
        git{,-{extras,lfs}} \
        glances \
        gperf \
        gstreamer1.0-tools libgstreamer1.0-dev \
        gzip \
        hdf5-{helpers,tools} h5utils libhdf5-{{,{mpi,mpich,openmpi}-}dev,doc} \
        htop \
        icu-devtools \
        'iputils-*' \
        jq \
        ldap-utils slapd \
        lib{asan{0,2,3,4,5},tsan0,ubsan{0,1}} \
        lib{atlas-base,boost-all,bz2,edit,eigen3,gflags,gif,google-glog,grpc++,gtest,hwloc,jemalloc,jpeg,jsoncpp,lapack,leveldb,lmdb,lzma,ncurses5,openblas,opencv,png,rados,rocksdb,snappy,ssl,tiff}-dev \
        libfreetype6{,-dev} \
        liblz4-dev liblz4-tool \
        libnuma-dev numactl numad \
        libpapi-dev papi-tools \
        libprotobuf-dev protobuf-compiler \
        libtool \
        llvm-7{,-tools} {clang{,-{format,tidy,tools}},lld,lldb}-7 lib{c++{,abi},omp}-7-dev \
        locate \
        ltrace \
        m4 \
        make \
        moreutils \
        mtr \
        ninja-build \
        pandoc \
        parallel \
        pciutils \
        pigz \
        pv \
        pybind11-dev \
        python3{,-pip} \
        qt5-default \
        rapidjson-dev \
        rsync \
        ruby-all-dev \
        strace \
        software-properties-common \
        subversion-tools \
        tar \
        time \
        tmux \
        txt2man \
        usbutils \
        util-linux \
        uuid-{dev,runtime} \
        valgrind \
        vim \
        wget \
        xz-utils pxz \
        zstd libzstd-dev \
    && sudo apt-get autoremove -y \
    && sudo apt-get clean \
    && sudo update-alternatives --set libblas.so.3-x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/atlas/libblas.so.3 \
    && sudo update-alternatives --set liblapack.so.3-x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/atlas/liblapack.so.3 \
    && sudo parallel --will-cite < /dev/null \
    && truncate -s0 ~/.bash_history
RUN /etc/roaster/scripts/setup.sh fpm
